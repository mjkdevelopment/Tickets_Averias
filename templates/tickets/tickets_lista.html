{% extends "base.html" %}
{% block title %}Tickets{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Tickets</h2>
    {% if user.puede_crear_tickets %}
        <a href="{% url 'ticket_crear' %}" class="btn btn-primary">Nuevo ticket</a>
    {% endif %}
</div>

<!-- Filtros de estado -->
<div class="mb-3">
    <div class="btn-group btn-group-sm" role="group">
        <a href="{% url 'tickets_lista' %}?ver=abiertos"
           class="btn {% if ver == 'abiertos' %}btn-primary{% else %}btn-outline-primary{% endif %}">
            Solo abiertos
        </a>
        <a href="{% url 'tickets_lista' %}?ver=todos"
           class="btn {% if ver == 'todos' %}btn-primary{% else %}btn-outline-primary{% endif %}">
            Todos
        </a>
        <a href="{% url 'tickets_lista' %}?ver=cerrados"
           class="btn {% if ver == 'cerrados' %}btn-primary{% else %}btn-outline-primary{% endif %}">
            Solo resueltos/cerrados
        </a>
    </div>
</div>

<table class="table table-striped table-hover">
    <thead>
        <tr>
            <th>Número</th>
            <th>Local</th>
            <th>Categoría</th>
            <th>Título</th>
            <th>Prioridad</th>
            <th>Estado</th>
            <th>Creado</th>
            <th>Asignado a</th>
            <th></th>
        </tr>
    </thead>
    <tbody>
    {% for ticket in tickets %}
        <tr
            {% if ticket.estado == 'RESUELTO' or ticket.estado == 'CERRADO' %}
                class="table-success"
            {% elif ticket.estado == 'EN_PROCESO' %}
                class="table-warning"
            {% endif %}
        >
            <td>{{ ticket.numero_ticket }}</td>
            <td>{{ ticket.local.codigo }} - {{ ticket.local.nombre }}</td>
            <td>{{ ticket.categoria.nombre }}</td>
            <td>{{ ticket.titulo }}</td>
            <td>{{ ticket.get_prioridad_display }}</td>
            <td>{{ ticket.get_estado_display }}</td>
            <td>{{ ticket.fecha_creacion|date:"d/m/Y H:i" }}</td>
            <td>
                {% if ticket.asignado_a %}
                    {{ ticket.asignado_a.get_full_name|default:ticket.asignado_a.username }}
                {% else %}
                    <span class="text-muted">Sin asignar</span>
                {% endif %}
            </td>
            <td>
                <a href="{% url 'ticket_detalle' ticket.pk %}"
                   class="btn btn-sm btn-outline-secondary">
                    Ver
                </a>
            </td>
        </tr>
    {% empty %}
        <tr>
            <td colspan="9" class="text-center text-muted">
                No hay tickets para mostrar.
            </td>
        </tr>
    {% endfor %}
    </tbody>
</table>
{% endblock %}
